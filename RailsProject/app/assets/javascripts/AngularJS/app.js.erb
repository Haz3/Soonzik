SoonzikApp = angular.module('SoonzikApp', ['ngRoute', 'ngCookies', 'ngResource', 'ngFileUpload', 'angular-loading-bar', 'ngAnimate', 'mm.foundation', 'uiGmapgoogle-maps', 'facebook', 'directive.g+signin']);

SoonzikApp.config(['$routeProvider', '$locationProvider', '$httpProvider', function($routeProvider, $locationProvider, $httpProvider) {
	var url = document.location.pathname;

	var whitelist = [
		/\/users\/[0-9]+\/finish_signup/,
		/\/users\/sign_in/,
		/\/users\/sign_up/,
		/\/users\/sign_out/,
		/\/users\/password\/new/,
		/\/feedbacks\/new/
	];

	var dynamicPage = true;
	for (var index in whitelist) {
		if (whitelist[index].test(url) == true) {
			dynamicPage = false;
			break;
		}
	}

	if (dynamicPage) {
		$locationProvider.html5Mode(true);
		$routeProvider.when('/', {
			templateUrl: '<%= asset_path("AngularJS/views/others/index.html.haml") %>',
			controller: 'IndexCtrl'
		}).when('/_=_', {
			templateUrl: '<%= asset_path("AngularJS/views/others/index.html.haml") %>',
			controller: 'IndexCtrl'
		}).when('/news/', {
			templateUrl: '<%= asset_path("AngularJS/views/news/index.html.haml") %>',
			controller: 'NewsCtrl'
		}).when('/news/:id', {
			templateUrl: '<%= asset_path("AngularJS/views/news/show.html.haml") %>',
			controller: 'NewsCtrl'
		}).when('/packs', {
			templateUrl: '<%= asset_path("AngularJS/views/packs/index.html.haml") %>',
			controller: 'PacksCtrl'
		}).when('/packs/:id', {
			templateUrl: '<%= asset_path("AngularJS/views/packs/show.html.haml") %>',
			controller: 'PacksCtrl'
		}).when('/users/:id', {
			templateUrl: '<%= asset_path("AngularJS/views/users/show.html.haml") %>',
			controller: 'UsersCtrl'
		}).when('/users/:id/edit', {
			templateUrl: '<%= asset_path("AngularJS/views/users/edit.html.haml") %>',
			controller: 'UsersCtrl'
		}).when('/users/:id/friendlist', {
			templateUrl: '<%= asset_path("AngularJS/views/friend/index.html.haml") %>',
			controller: 'FriendCtrl'
		}).when('/battles', {
			templateUrl: '<%= asset_path("AngularJS/views/battles/index.html.haml") %>',
			controller: 'BattlesCtrl'
		}).when('/battles/:id', {
			templateUrl: '<%= asset_path("AngularJS/views/battles/show.html.haml") %>',
			controller: 'BattlesCtrl'
		}).when('/carts/my_cart', {
			templateUrl: '<%= asset_path("AngularJS/views/cart/show.html.haml") %>',
			controller: 'CartCtrl'
		}).when('/playlists/:id', {
			templateUrl: '<%= asset_path("AngularJS/views/playlists/show.html.haml") %>',
			controller: 'PlaylistsCtrl'
		}).when('/listenings', {
			templateUrl: '<%= asset_path("AngularJS/views/listenings/index.html.haml") %>',
			controller: 'ListeningsCtrl'
		}).when('/search/:value', {
			templateUrl: '<%= asset_path("AngularJS/views/search/index.html.haml") %>',
			controller: 'SearchCtrl'
		}).when('/explorer', {
			templateUrl: '<%= asset_path("AngularJS/views/explorer/index.html.haml") %>',
			controller: 'ExplorerCtrl'
		}).when('/explorer/:influence', {
			templateUrl: '<%= asset_path("AngularJS/views/explorer/index.html.haml") %>',
			controller: 'ExplorerCtrl'
		}).when('/explorer/:influence/:genre', {
			templateUrl: '<%= asset_path("AngularJS/views/explorer/index.html.haml") %>',
			controller: 'ExplorerCtrl'
		}).when('/albums/:id', {
			templateUrl: '<%= asset_path("AngularJS/views/albums/show.html.haml") %>',
			controller: 'AlbumsCtrl'
		}).when('/notifications', {
			templateUrl: '<%= asset_path("AngularJS/views/notifications/index.html.haml") %>',
			controller: 'NotifsCtrl'
		}).when('/concerts', {
			templateUrl: '<%= asset_path("AngularJS/views/concerts/index.html.haml") %>',
			controller: 'ConcertsCtrl'
		}).when('/my_music', {
			templateUrl: '<%= asset_path("AngularJS/views/discotheque/index.html.haml") %>',
			controller: 'DiscothequeCtrl'
		});
	}

	$httpProvider.defaults.useXDomain = true;
	delete $httpProvider.defaults.headers.common["X-Requested-With"];
}]);

SoonzikApp.config(function(uiGmapGoogleMapApiProvider) {
		uiGmapGoogleMapApiProvider.configure({
				key: 'AIzaSyBdbSsqSM-wMia6xhlQmlVt5cDL18GUsk0',
				v: '3.17',
				libraries: 'weather,geometry,visualization'
		});
});

SoonzikApp.run(['$route', '$rootScope', '$location', 'SecureAuth', 'HTTPService', '$routeParams', function ($route, $rootScope, $location, SecureAuth, HTTPService, $routeParams) {
	var original = $location.path;

	$location.path = function (path, reload) {
		if (reload === false) {
			var lastRoute = $route.current;
			var un = $rootScope.$on('$locationChangeSuccess', function () {
				$route.current = lastRoute;
				un();
			});
		}
		return original.apply($location, [path]);
	};

	$rootScope.labels = labels;

	$rootScope.range = function(n) {
		if (Math.floor(n) > 0)
	  	return new Array(Math.floor(n));
	  else
	  	return [];
	}

	$rootScope.min = function(a, b) {
		return (a < b ? a : b);
	}

	$rootScope.max = function(a, b) {
		return (a > b ? a : b);
	}

	$rootScope.toInt = function(value) {
		var number = parseInt(value);
		if (isNaN(number)) {
			return 0;
		} else {
			return number;
		}
	}

	$rootScope.likeResource = function(resourceName) {
		var resource = resourceName.charAt(0).toUpperCase() + resourceName.slice(1);

		SecureAuth.securedTransaction(function(key, id) {
			var parameters = {
				secureKey: key,
		  		user_id: id,
		  		like: {
		  			user_id: id,
		  			typeObj: resource,
		  			obj_id: $routeParams.id
		  		}
		  	};

			HTTPService.likeResource(parameters).then(function(response) {
				$rootScope.likes++;
			}, function(error) {
				//NotificationService.error(" fail like ");
			});
		}, function(error) {
			//NotificationService.error(" fail like ");
		});
	}
}]);

SoonzikApp.config(function(FacebookProvider) {
	FacebookProvider.init('572371212865769');
})